**概述：**

Zookeeper 是一个分布式协调服务的开源框架。主要用来解决分布式集群中应用系统的一致性问题，例如怎样避免同时操作同一数据造成脏读的问题。

Zookeeper 本质上是一个分布式的小文件存储系统。提供基于类似于文件系统的目录树方式的数据存储，并且可以对树中的节点进行有效管理。从而用来维护和监控存储数据的状态变化。通过监控这些数据状态的变化，从而达到基于数据的集群管理。

例如：统一命名服务，分布式配置管理，分布式消息队列，分布式锁，分布式协调等功能。



**特性：**

1. 全局数据一致：每个 server 保存一份相同的数据副本，client 无论连接到哪个 server，展示的数据都是一致的，这是最重要的特征；
2. 可靠性：如果消息被其中一台服务器接受，那么将会被所有的服务器接受；
3. 顺序性：包括全局有序和偏序两种，**全局有序**是指如果在一台服务器上消息 a 在消息 b 前发布 ，则在所有 server 上消息 a 都将在消息 b 前被发布；**偏序**是指如果一个消息 b 在消息 a 后被同一个发布者发布，a 必将排在 b 之前。
4. 数据更新原子性：一次数据更新要么成功（半数以上的节点成功），要么失败，不存在中间状态。
5. 实时性：Zookeeper 保证客户端将在一个时间间隔范围内获得服务器的更新信息，或者服务器的失效信息。



Zookeeper 集群角色

**leader：**

Zookeeper 集群工作的核心

事务请求（写操作）的唯一调度和处理者，保证集群事务处理的顺序性

集群内部各个服务器的调度者

对于 create，setData，delete 等有写操作的请求，则需要统一转发给 leader 处理，leader 需要决定编号，执行操作，这个过程称为一个事务。

**Follower：**

处理客户端非事务（读操作）请求，转发事务请求给 leader

参与集群 leader 选举投票

**Observe：**

观察者角色，观察 Zookeeper 集群的最新状态变化并将这些状态同步过来，其对于非事务请求可以独立处理，对于事务请求，则会转发给 leader 服务器进行处理。

不会参与任何形式的投票，只提供非事务服务，通常用于在不影响集群事务处理能力的前提下提升集群的非事务处理能力。



**ZooKeeper 集群搭建：**

指 ZooKeeper 分布式模式安装。通常由 2n+1 台 servers 组成。

这是因为为了保证 Leader 选举（基于 Paxos 算法的实现）能够得到多数的支持，所以 ZooKeeper 集群的数量一般为 奇数。



**ZooKeeper 数据模型：**

Zookeeper 的数据模型，在结构上和标准的文件系统十分相似，拥有一个层次的命名空间，都是采用**树形层次结构**，ZooKeeper树中的每个节点被称为--Znode。

和文件系统的目录树一样，ZooKeeper树中的每个节点可以拥有子节点。

但也有不同之处：

1. **Znode 兼具文件和目录两种特点**。既像文件一样维护者数据，元信息，ACL，时间戳等数据结构，又像目录一样可以作为路径标识的一部分，并可以具有子 Znode。用户对 Znode 具有增，删，改，查等操作的权限。
2. **Znode 具有原子性操作**，读操作将获取与节点相关的所有数据，写操作也将替换掉节点的所有数据。另外，每一个节点都拥有自己的 ACL（访问控制列表），这个列表规定了用户的权限，即限定了特定用户对目标节点可以执行的操作。
3. **Znode 存储数据大小有限制**。ZooKeeper 虽然可以关联一些数据，但并没有被设计为常规的数据库或者大数据存储，相反的是，它用来管理调度数据，比如分布式应用中的配置文件信息，状态信息，汇集位置等。这些数据的共性就是都比较小，通常以 KB 为单位。ZooKeeper 的服务器和客户端都被设计为严格检查并限制每个 Znode 的数据大小至多 1M。
4. **Znode 通过路径引用**，路径必须为绝对的，因此他们必须由斜杠字符来开头。除此之外，他们必须是唯一的，也就是说每一个路径只有一个表示，因此这些路径不能改变。在 ZooKeeper 中，路径由 Unicode 字符串组成，并且有一些限制。字符串 “/ZooKeeper” 用以保存管理信息，比如关键配额信息。



每个 Znode 由三个部分组成：

1. stat：状态信息，描述 Znode 的版本，权限等信息
2. data：与该 Znode 关联的数据
3. children：该 Znode 下的子节点